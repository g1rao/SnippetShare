<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnippetShare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .muted { color: #9ca3af; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">SnippetShare</h1>
        <div class="text-sm muted">by Jeevan Rao</div>
      </div>
      <div class="flex gap-3">
        <button id="new-btn" class="px-3 py-2 bg-blue-600 text-white rounded">New Snippet</button>
        <button id="refresh-btn" class="px-3 py-2 bg-gray-200 rounded">Refresh</button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Sidebar -->
      <aside class="lg:col-span-1 bg-white rounded shadow p-4 h-[72vh] overflow-auto">
        <input id="search" placeholder="Search snippets..." class="w-full px-3 py-2 rounded border" />
        <div id="list" class="mt-3 space-y-2"></div>
        <p id="empty" class="mt-3 text-sm muted hidden">No snippets yet.</p>
      </aside>

      <!-- Editor -->
      <section class="lg:col-span-3 bg-white rounded shadow p-4 flex flex-col" >
        <div class="flex items-center justify-between mb-3 gap-3">
          <div class="flex items-center gap-2">
            <button id="save" class="px-3 py-2 bg-green-600 text-white rounded">Save (Ctrl/Cmd+S)</button>
            <button id="delete" class="px-3 py-2 bg-red-600 text-white rounded">Delete</button>
            <button id="copy" class="px-3 py-2 bg-gray-200 rounded">Copy</button>
            <button id="preview" class="px-3 py-2 bg-indigo-600 text-white rounded">Preview</button>
            <label class="ml-4 flex items-center gap-2 muted">
              <input id="autosave" type="checkbox" /> Autosave
            </label>
          </div>
          <div class="text-sm muted">ID: <span id="sid">—</span></div>
        </div>

        <textarea id="editor" class="flex-1 border rounded p-3 text-sm" placeholder="Type your snippet here..." ></textarea>

        <div class="mt-3 flex items-center justify-between">
          <div id="status" class="text-sm muted">Ready</div>
          <div class="text-sm muted">Last saved: <span id="last-saved">—</span></div>
        </div>
      </section>
    </div>

    <!-- Preview modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
      <div class="bg-white rounded p-4 w-11/12 max-w-3xl">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold">Preview</h3>
          <button id="close-modal" class="px-2 py-1 bg-gray-200 rounded">Close</button>
        </div>
        <pre id="preview-content" class="bg-gray-100 p-3 rounded max-h-[60vh] overflow-auto"></pre>
      </div>
    </div>
  </div>

  <script type="module">
    const API = '/api/snippets';
    const listEl = document.getElementById('list');
    const editor = document.getElementById('editor');
    const search = document.getElementById('search');
    const saveBtn = document.getElementById('save');
    const newBtn = document.getElementById('new-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const sidEl = document.getElementById('sid');
    const status = document.getElementById('status');
    const lastSaved = document.getElementById('last-saved');
    const autosave = document.getElementById('autosave');
    const copyBtn = document.getElementById('copy');
    const previewBtn = document.getElementById('preview');
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('close-modal');
    const previewContent = document.getElementById('preview-content');
    const deleteBtn = document.getElementById('delete');
    const empty = document.getElementById('empty');

    let snippets = [];
    let currentId = null;
    let autosaveInterval = null;

    function toast(t){ status.textContent = t; setTimeout(()=>status.textContent='Ready', 2500); }

    async function loadAll(){
      try {
        const res = await fetch(API);
        snippets = await res.json();
        renderList(snippets);
      } catch (e){ console.error(e); toast('Load failed'); }
    }

    function renderList(items){
      listEl.innerHTML = '';
      if (!items.length){ empty.classList.remove('hidden'); return; } else empty.classList.add('hidden');
      items.forEach(s=>{
        const btn = document.createElement('button');
        btn.className = 'w-full text-left p-2 rounded hover:bg-gray-50';
        btn.innerHTML = `<div class="font-medium">${escapeHtml((s.content||'').split('\n')[0].slice(0,80))}</div><div class="text-xs muted">${new Date(s.created_at).toLocaleString()}</div>`;
        btn.addEventListener('click', ()=> loadOne(s.id));
        listEl.appendChild(btn);
      });
    }

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function loadOne(id){
      try {
        const r = await fetch(`${API}/${encodeURIComponent(id)}`);
        if (r.status===404){ toast('Not found'); return; }
        const s = await r.json();
        editor.value = s.content || '';
        currentId = s.id;
        sidEl.textContent = s.id;
        lastSaved.textContent = new Date(s.created_at).toLocaleString();
        window.history.replaceState({}, '', `?id=${s.id}`);
      } catch (e){ console.error(e); toast('Load failed'); }
    }

    async function save(){
      const content = editor.value.trim();
      if (!content) { toast('Empty not saved'); return; }
      saveBtn.disabled = true;
      try {
        let res;
        if (currentId) {
          res = await fetch(`${API}/${encodeURIComponent(currentId)}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ content })
          });
        } else {
          res = await fetch(API, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ content })
          });
        }
        if (!res.ok) throw new Error('save failed');
        const data = await res.json();
        currentId = data.id ?? currentId;
        sidEl.textContent = currentId;
        lastSaved.textContent = new Date().toLocaleString();
        toast('Saved');
        await loadAll();
        window.history.replaceState({}, '', `?id=${currentId}`);
      } catch (e){ console.error(e); toast('Save failed'); } finally { saveBtn.disabled=false; }
    }

    saveBtn.addEventListener('click', save);
    refreshBtn.addEventListener('click', loadAll);
    newBtn.addEventListener('click', ()=>{ currentId = null; sidEl.textContent='—'; editor.value=''; lastSaved.textContent='—'; window.history.replaceState({}, '', window.location.pathname); });

    // Delete
    deleteBtn.addEventListener('click', async ()=>{
      if (!currentId) return toast('No snippet selected');
      if (!confirm('Delete this snippet?')) return;
      try {
        const r = await fetch(`${API}/${encodeURIComponent(currentId)}`, { method: 'DELETE' });
        if (r.status === 204) {
          toast('Deleted');
          currentId = null;
          sidEl.textContent='—';
          editor.value='';
          await loadAll();
          window.history.replaceState({}, '', window.location.pathname);
        } else toast('Delete failed');
      } catch (e){ console.error(e); toast('Delete failed'); }
    });

    // Search
    search.addEventListener('input', ()=> {
      const q = search.value.toLowerCase();
      renderList(snippets.filter(s=> (s.content||'').toLowerCase().includes(q)));
    });

    // Copy
    copyBtn.addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(editor.value); toast('Copied'); } catch(e){ toast('Copy failed'); }
    });

    // Preview
    previewBtn.addEventListener('click', ()=> {
      previewContent.textContent = editor.value;
      modal.classList.remove('hidden');
      modal.style.display='flex';
    });
    closeModal.addEventListener('click', ()=> { modal.classList.add('hidden'); modal.style.display='none'; });

    // Keyboard shortcut
    window.addEventListener('keydown', (e)=> {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); save(); }
      if (e.key === 'Escape') { editor.value=''; toast('Cleared'); }
    });

    // Autosave
    autosave.addEventListener('change', ()=> {
      if (autosave.checked) {
        autosaveInterval = setInterval(()=>{ if (editor.value.trim()) save(); }, 8000);
        toast('Autosave on (8s)');
      } else {
        clearInterval(autosaveInterval);
        autosaveInterval = null;
        toast('Autosave off');
      }
    });

    // Init: load all, optionally open ?id=
    (async function init(){
      await loadAll();
      const p = new URLSearchParams(window.location.search);
      const id = p.get('id');
      if (id) await loadOne(id);
    })();
  </script>
</body>
</html>
